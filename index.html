<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>VR Cardboard via GitHub Pages — Mixed Reality</title>
<style>
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:sans-serif;overflow:hidden}
  #overlay{
    position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
    background:rgba(0,0,0,.6);z-index:10;
  }
  button{font-size:20px;padding:12px 20px;border:0;border-radius:10px;background:#1e88e5;color:white}
  #canvas{width:100%;height:100%;display:block}
</style>
</head>
<body>

<div id="overlay">
  <h1>VR Demo</h1>
  <button id="start">Iniciar VR</button>
  <p>Permita o uso da câmera e sensores ao iniciar.</p>
</div>

<canvas id="canvas"></canvas>

<script type="module">
import * as THREE from "https://unpkg.com/three@0.159.0/build/three.module.js";
import { DeviceOrientationControls } from "./DeviceOrientationControls.js";


const startBtn = document.getElementById("start");
const overlay = document.getElementById("overlay");
const canvas = document.getElementById("canvas");

let renderer, scene, camL, camR, controls, video, texture;

startBtn.onclick = async () => {
    overlay.style.display = "none";

    // ====== CAMERA ======
    video = document.createElement("video");
    video.setAttribute("playsinline", "");
    video.muted = true;

    const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false
    });

    video.srcObject = stream;
    await video.play();

    texture = new THREE.VideoTexture(video);

    // ====== THREE SETUP ======
    renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(devicePixelRatio);

    scene = new THREE.Scene();

    const aspect = window.innerWidth / window.innerHeight;
    camL = new THREE.PerspectiveCamera(70, aspect/2, 0.1, 100);
    camR = new THREE.PerspectiveCamera(70, aspect/2, 0.1, 100);

    // IPD (distância dos olhos)
    camL.position.x = -0.03;
    camR.position.x =  0.03;

    // Controle por sensores
    controls = new DeviceOrientationControls(camL);  
    // OBS: Controla só o camL, e depois copiamos a rotação p/ camR

    // ====== FUNDO DA CAMERA ======
    const geo = new THREE.PlaneGeometry(2,2);
    const mat = new THREE.MeshBasicMaterial({ map: texture });
    const bg = new THREE.Mesh(geo, mat);
    bg.position.z = -1.5;
    scene.add(bg);

    // ====== OBJETO 3D ======
    const boxGeo = new THREE.BoxGeometry(0.3,0.3,0.3);
    const boxMat = new THREE.MeshNormalMaterial();
    const cube = new THREE.Mesh(boxGeo, boxMat);
    cube.position.z = -2;
    scene.add(cube);

    // ====== LOOP ======
    function animate(){
        requestAnimationFrame(animate);

        controls.update();
        camR.quaternion.copy(camL.quaternion);

        cube.rotation.x += 0.01;
        cube.rotation.y += 0.02;

        const w = window.innerWidth;
        const h = window.innerHeight;

        renderer.setScissorTest(true);

        // LEFT EYE
        renderer.setViewport(0, 0, w/2, h);
        renderer.setScissor(0, 0, w/2, h);
        renderer.render(scene, camL);

        // RIGHT EYE
        renderer.setViewport(w/2, 0, w/2, h);
        renderer.setScissor(w/2, 0, w/2, h);
        renderer.render(scene, camR);

        renderer.setScissorTest(false);
    }

    animate();
};

// resize
window.addEventListener("resize", () => {
    renderer.setSize(innerWidth, innerHeight);
});
</script>

</body>
</html>
