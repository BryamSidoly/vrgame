<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>AR Sensor + Camera</title>

<style>
  html,body {
    margin:0;
    height:100%;
    overflow:hidden;
    background:#000;
  }
  #canvas {
    width:100%;
    height:100%;
    display:block;
  }
</style>
</head>
<body>

<canvas id="canvas"></canvas>

<script type="module">
import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
import { DeviceOrientationControls } 
from "https://bryamsidoly.github.io/vrgame/DeviceOrientationControls.js";

const canvas = document.getElementById("canvas");
let renderer, scene, camera;
let video, videoTexture;
let cube, controls;

async function start() {

    /* ======== CONFIGURA CÂMERA ======== */
    video = document.createElement("video");
    video.setAttribute("playsinline", "");
    video.muted = true;

    const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" }},
        audio: false
    });

    video.srcObject = stream;
    await video.play();

    /* ======== TEXTURA DE VÍDEO ======== */
    videoTexture = new THREE.VideoTexture(video);
    videoTexture.minFilter = THREE.LinearFilter;
    videoTexture.magFilter = THREE.LinearFilter;
    videoTexture.format = THREE.RGBAFormat;
    videoTexture.colorSpace = THREE.SRGBColorSpace;

    /* ======== THREE.JS ======== */
    renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
    renderer.setPixelRatio(devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);

    scene = new THREE.Scene();
    scene.background = videoTexture;   // usa vídeo como fundo

    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 100);
    camera.position.set(0,0,0);

    /* ======== OBJETO 3D ======== */
    const geo = new THREE.BoxGeometry(0.3,0.3,0.3);
    const mat = new THREE.MeshNormalMaterial();
    cube = new THREE.Mesh(geo, mat);
    cube.position.set(0,0,-2); // 2m à frente
    scene.add(cube);

    /* ======== SENSORES ======== */
    controls = new DeviceOrientationControls(camera);

    /* ======== LOOP ======== */
    function render() {
        controls.update();
        cube.rotation.y += 0.01;

        renderer.render(scene, camera);
        video.requestVideoFrameCallback(render);
    }
    video.requestVideoFrameCallback(render);
}

start();


/* ======== RESIZE ======== */
window.addEventListener("resize", () => {
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
});
</script>

</body>
</html>
